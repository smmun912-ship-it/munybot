name: YouTube Daily Digest

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 7ì‹œ KST (UTC 22:00 ì „ë‚ )
    - cron: "0 22 * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

permissions:
  contents: write
  pages: write

jobs:
  daily-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt python-telegram-bot

      - name: Run pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONIOENCODING: utf-8
        run: python main.py

      - name: Deploy to GitHub Pages
        run: |
          # ì˜¤ëŠ˜ ë‚ ì§œ ë””ë ‰í† ë¦¬ ì°¾ê¸°
          TODAY=$(date +%Y-%m-%d -d "+9 hours")
          OUTPUT_DIR="output/$TODAY"

          if [ -d "$OUTPUT_DIR" ]; then
            # docs ë””ë ‰í† ë¦¬ì— ìµœì‹  ê²°ê³¼ ë³µì‚¬
            mkdir -p docs
            cp "$OUTPUT_DIR/slides.html" docs/slides.html 2>/dev/null || true
            cp "$OUTPUT_DIR/infographic.html" docs/infographic.html 2>/dev/null || true
            cp "$OUTPUT_DIR/combined_summary.md" docs/summary.md 2>/dev/null || true
            cp "$OUTPUT_DIR/podcast_script.md" docs/podcast.md 2>/dev/null || true
            
            # index.html ìƒì„±
            cat > docs/index.html << 'INDEXEOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>AI/í…Œí¬ ë°ì¼ë¦¬ ë‹¤ì´ì œìŠ¤íŠ¸</title>
            <style>
              @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
              * { margin:0; padding:0; box-sizing:border-box; }
              body { font-family:'Noto Sans KR',sans-serif; background:#0f0c29; color:#e8e8e8; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px; }
              h1 { font-size:2em; background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; }
              .subtitle { color:rgba(255,255,255,0.5); margin-bottom:40px; }
              .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px; max-width:900px; width:100%; }
              .card { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:30px; text-align:center; transition:transform 0.3s,box-shadow 0.3s; text-decoration:none; color:#e8e8e8; }
              .card:hover { transform:translateY(-6px); box-shadow:0 12px 40px rgba(102,126,234,0.3); }
              .card .icon { font-size:3em; margin-bottom:15px; }
              .card h2 { font-size:1.2em; margin-bottom:8px; color:#a5b4fc; }
              .card p { font-size:0.85em; color:rgba(255,255,255,0.5); }
              .footer { margin-top:40px; color:rgba(255,255,255,0.25); font-size:0.8em; }
            </style>
          </head>
          <body>
            <h1>AI/í…Œí¬ ë°ì¼ë¦¬ ë‹¤ì´ì œìŠ¤íŠ¸</h1>
            <p class="subtitle">ë§¤ì¼ ìë™ ì—…ë°ì´íŠ¸ë˜ëŠ” AI ìœ íŠœë¸Œ ì¢…í•© ì½˜í…ì¸ </p>
            <div class="cards">
              <a class="card" href="slides.html"><div class="icon">ğŸ“Š</div><h2>ìŠ¬ë¼ì´ë“œ</h2><p>Reveal.js í”„ë ˆì  í…Œì´ì…˜</p></a>
              <a class="card" href="infographic.html"><div class="icon">ğŸ¨</div><h2>ì¸í¬ê·¸ë˜í”½</h2><p>í•µì‹¬ íŠ¸ë Œë“œ ì‹œê°í™”</p></a>
              <a class="card" href="podcast.md"><div class="icon">ğŸ™ï¸</div><h2>íŒŸìºìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸</h2><p>ë‘ ì§„í–‰ì ëŒ€í™” í˜•ì‹</p></a>
              <a class="card" href="summary.md"><div class="icon">ğŸ“„</div><h2>ì¢…í•© ë³´ê³ ì„œ</h2><p>ì „ì²´ ì±„ë„ í†µí•© ìš”ì•½</p></a>
            </div>
            <div class="footer">Auto-generated by YouTube-NotebookLM Agent</div>
          </body>
          </html>
          INDEXEOF
            echo "âœ… GitHub Pages íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ"
          else
            echo "âš ï¸ ì¶œë ¥ ë””ë ‰í† ë¦¬ ì—†ìŒ: $OUTPUT_DIR"
          fi

      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PAGES_URL: ${{ secrets.PAGES_URL }}
        run: python telegram_notifier.py

      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ“Š Daily digest $(date +%Y-%m-%d -d '+9 hours')"
          git push
